---
description: MongoDB è³‡æ–™åº«æ¶æ§‹è¨­è¨ˆæŒ‡å—ã€‚ç•¶ä½ éœ€è¦æŸ¥è©¢ MongoDB Collections çµæ§‹ã€è³‡æ–™æ¨¡å‹å®šç¾©ã€ç´¢å¼•é…ç½®ã€è³‡æ–™åº«é€£ç·šè¨­å®šï¼Œæˆ–é€²è¡Œè³‡æ–™åº«ç›¸é—œé–‹ç™¼æ™‚èª¿ç”¨æ­¤è¦å‰‡ã€‚æ¶µè“‹ä¼æ¥­è³‡æ–™ã€æ¨™æ¡ˆè³‡æ–™ã€AIå·¥å…·ç­‰æ ¸å¿ƒæ¥­å‹™é›†åˆçš„å®Œæ•´è¨­è¨ˆè¦ç¯„ã€‚
globs: 
alwaysApply: false
---
# Business Magnifier MongoDB æ¶æ§‹è¨­è¨ˆæŒ‡å—

## ğŸ¯ å°ˆæ¡ˆæ¦‚è¿°

Business Magnifier æ˜¯ä¸€å€‹ä¼æ¥­è³‡æ–™åˆ†æå¹³å°ï¼Œä½¿ç”¨ MongoDB ä½œç‚ºä¸»è¦è³‡æ–™åº«ã€‚æœ¬æŒ‡å—è©³ç´°èªªæ˜å°ˆæ¡ˆä¸­éœ€è¦å»ºç½®çš„æ‰€æœ‰ MongoDB Collectionsï¼ŒåŒ…æ‹¬å…¶ç”¨é€”ã€è³‡æ–™çµæ§‹å’Œç´¢å¼•é…ç½®ã€‚

## ğŸ“Š è³‡æ–™åº«æ¶æ§‹

**è³‡æ–™åº«åç¨±**: `business-magnifier`  
**MongoDB é€£ç·šå­—ä¸²**: `mongodb://admin:password@localhost:27017/business-magnifier?authSource=admin`

## ğŸ—‚ï¸ Collections æ¸…å–®èˆ‡è©³ç´°èªªæ˜

### 1. æ ¸å¿ƒæ¥­å‹™è³‡æ–™ Collections

#### 1.1 `companies` - ä¼æ¥­è³‡æ–™é›†åˆ
**ç”¨é€”**: å„²å­˜å°ç£ä¼æ¥­çš„åŸºæœ¬è³‡æ–™ã€è²¡å‹™è³‡è¨Šã€è‘£ç›£äº‹è³‡æ–™ç­‰å®Œæ•´ä¼æ¥­æª”æ¡ˆ

**ä¸»è¦æ¬„ä½çµæ§‹**:
```javascript
{
  _id: ObjectId,
  taxId: String,           // çµ±ä¸€ç·¨è™Ÿ (å”¯ä¸€è­˜åˆ¥)
  name: String,            // ä¼æ¥­åç¨±
  fullName: String,        // ä¼æ¥­å…¨å
  englishName: String,     // è‹±æ–‡åç¨±
  status: String,          // ä¼æ¥­ç‹€æ…‹ (æ ¸å‡†è¨­ç«‹/æ’¤éŠ·/å»¢æ­¢ç­‰)
  chairman: String,        // è² è²¬äºº
  industry: String,        // è¡Œæ¥­åˆ¥
  address: String,         // åœ°å€
  establishedDate: Date,   // è¨­ç«‹æ—¥æœŸ
  
  // è²¡å‹™è³‡è¨Š
  financial: {
    totalCapital: String,
    paidInCapital: String,
    employees: String,
    revenue: String
  },
  
  // è¯çµ¡è³‡è¨Š
  contact: {
    phone: String,
    email: String,
    website: String,
    fax: String
  },
  
  // ä¸Šå¸‚å…¬å¸è²¡å ±è³‡è¨Š
  financialReport: { ... },
  
  // è‘£ç›£äº‹è³‡è¨Š
  directors: [{ name, title, shares, representative }],
  
  // ç¶“ç†äººè³‡è¨Š
  managers: [{ åºè™Ÿ, å§“å, åˆ°è·æ—¥æœŸ }],
  
  // ç‡Ÿæ¥­é …ç›®
  businessScope: [[String]],
  
  // é—œè¯æ¨™æ¡ˆæ•¸é‡
  tenderCount: Number,
  
  // æœå°‹é—œéµå­—
  searchKeywords: [String],
  
  // æ™‚é–“æˆ³
  createdAt: Date,
  updatedAt: Date,
  lastUpdated: Date
}
```

**ç´¢å¼•é…ç½®**:
- `taxId_unique`: çµ±ä¸€ç·¨è™Ÿå”¯ä¸€ç´¢å¼•
- `text_search`: ä¼æ¥­åç¨±å…¨æ–‡æœå°‹ç´¢å¼•
- `industry_1`: è¡Œæ¥­åˆ¥ç´¢å¼•
- `establishedDate_-1`: è¨­ç«‹æ—¥æœŸé™åºç´¢å¼•

#### 1.2 `tenders` - æ”¿åºœæ¨™æ¡ˆè³‡æ–™é›†åˆ
**ç”¨é€”**: å„²å­˜æ”¿åºœæ¡è³¼ç¶²çš„æ¨™æ¡ˆè³‡æ–™ï¼Œç”¨æ–¼ sitemap ç”Ÿæˆå’Œæ¨™æ¡ˆæŸ¥è©¢

**ä¸»è¦æ¬„ä½çµæ§‹**:
```javascript
{
  _id: String,             // æ¨™æ¡ˆå”¯ä¸€è­˜åˆ¥ç¢¼ (unit_id_job_number æ ¼å¼)
  unitId: String,          // æ©Ÿé—œä»£ç¢¼
  jobNumber: String,       // æ¨™æ¡ˆç·¨è™Ÿ
  title: String,           // æ¨™æ¡ˆæ¨™é¡Œ
  unitName: String,        // æ©Ÿé—œåç¨±
  status: String,          // æ¨™æ¡ˆç‹€æ…‹ (active/open/published/closed)
  tenderValue: Number,     // æ¨™æ¡ˆé‡‘é¡
  publishDate: Date,       // ç™¼å¸ƒæ—¥æœŸ
  deadline: Date,          // æˆªæ­¢æ—¥æœŸ
  
  // æ¨™æ¡ˆè©³ç´°è³‡è¨Š
  detail: {
    type: String,          // æ¨™æ¡ˆé¡å‹
    description: String,   // æ¨™æ¡ˆèªªæ˜
    requirements: String,  // éœ€æ±‚è¦æ ¼
    evaluation: String     // è©•é¸æ–¹å¼
  },
  
  // ç›¸é—œä¼æ¥­
  companies: [{
    taxId: String,
    name: String,
    role: String           // å¾—æ¨™å» å•†/æŠ•æ¨™å» å•†
  }],
  
  // æ™‚é–“æˆ³
  createdAt: Date,
  updatedAt: Date
}
```

**ç´¢å¼•é…ç½®**:
- `id_index`: ä¸»éµç´¢å¼•
- `status_index`: ç‹€æ…‹ç´¢å¼•
- `tenderValue_-1`: æ¨™æ¡ˆé‡‘é¡é™åºç´¢å¼•
- `publishDate_-1`: ç™¼å¸ƒæ—¥æœŸé™åºç´¢å¼•

#### 1.3 `ai_tools` - AI å·¥å…·è³‡æ–™é›†åˆ
**ç”¨é€”**: å„²å­˜ AI å·¥å…·å’Œæç¤ºè©æ¨¡æ¿ï¼Œæ”¯æ´å·¥å…·åˆ†é¡å’Œä½¿ç”¨çµ±è¨ˆ

**ä¸»è¦æ¬„ä½çµæ§‹**:
```javascript
{
  _id: ObjectId,
  id: String,              // å·¥å…·å”¯ä¸€è­˜åˆ¥ç¢¼
  name: String,            // å·¥å…·åç¨±
  description: String,     // å·¥å…·æè¿°
  category: String,        // åˆ†é¡ (æç¤ºè©/AIå·¥å…·/SEO/å¥åº·ç­‰)
  tags: [String],          // æ¨™ç±¤
  
  // å·¥å…·é…ç½®
  config: {
    icon: String,          // åœ–ç¤º
    placeholder: String,   // è¼¸å…¥æç¤º
    instructions: {        // ä½¿ç”¨èªªæ˜
      what: String,
      why: String,
      how: String
    },
    promptTemplate: {      // æç¤ºè©æ¨¡æ¿
      prefix: String,
      suffix: String
    },
    renderConfig: {        // æ¸²æŸ“é…ç½®
      componentId: String,
      renderType: String,  // 'prompt' | 'component'
      isAITool: Boolean
    }
  },
  
  // ä½¿ç”¨çµ±è¨ˆ
  usage: {
    totalUses: Number,
    lastUsed: Date,
    popularityScore: Number
  },
  
  // ç‰ˆæœ¬æ§åˆ¶
  version: String,
  isActive: Boolean,
  
  // æ™‚é–“æˆ³
  createdAt: Date,
  updatedAt: Date
}
```

**ç´¢å¼•é…ç½®**:
- `id_unique`: å·¥å…· ID å”¯ä¸€ç´¢å¼•
- `category_active`: åˆ†é¡å’Œå•Ÿç”¨ç‹€æ…‹è¤‡åˆç´¢å¼•
- `tags_1_isActive_1`: æ¨™ç±¤å’Œå•Ÿç”¨ç‹€æ…‹è¤‡åˆç´¢å¼•

### 2. API å¿«å– Collections

#### 2.1 `pcc_api_cache` - æ”¿åºœæ¡è³¼ç¶² API å¿«å–
**ç”¨é€”**: å¿«å–æ”¿åºœæ¡è³¼ç¶² API å›æ‡‰ï¼Œæ¸›å°‘å¤–éƒ¨ API å‘¼å«ï¼Œæå‡æ•ˆèƒ½

**è³‡æ–™çµæ§‹**:
```javascript
{
  _id: ObjectId,
  api_key: String,         // API è«‹æ±‚çš„å”¯ä¸€éµå€¼ (é€šå¸¸æ˜¯å®Œæ•´ URL)
  data: Mixed,             // å¿«å–çš„ API å›æ‡‰è³‡æ–™
  fetched_at: Date,        // è³‡æ–™æ“·å–æ™‚é–“
  expires_at: Date,        // éæœŸæ™‚é–“ (TTL: 24å°æ™‚)
}
```

**ä½¿ç”¨å ´æ™¯**:
- æ¨™æ¡ˆæœå°‹ API (`/api/searchbycompanyid`, `/api/searchbytitle`)
- æ¨™æ¡ˆè©³ç´°è³‡æ–™ API (`/api/tender`)
- ä¼æ¥­æ¨™æ¡ˆæŸ¥è©¢ API

**ç´¢å¼•é…ç½®**:
- `api_key_unique`: API éµå€¼å”¯ä¸€ç´¢å¼•
- `expires_at_ttl`: TTL ç´¢å¼•ï¼Œè‡ªå‹•æ¸…ç†éæœŸè³‡æ–™

### 3. ç³»çµ±ç®¡ç† Collections

#### 3.1 `api_logs` - API è¨ªå•æ—¥èªŒ
**ç”¨é€”**: è¨˜éŒ„ API è¨ªå•ç´€éŒ„ï¼Œç”¨æ–¼ç›£æ§å’Œåˆ†æ

**è³‡æ–™çµæ§‹**:
```javascript
{
  _id: ObjectId,
  endpoint: String,        // API ç«¯é»
  method: String,          // HTTP æ–¹æ³•
  params: Object,          // è«‹æ±‚åƒæ•¸
  response_time: Number,   // å›æ‡‰æ™‚é–“ (ms)
  status_code: Number,     // HTTP ç‹€æ…‹ç¢¼
  ip_address: String,      // å®¢æˆ¶ç«¯ IP
  user_agent: String,      // ä½¿ç”¨è€…ä»£ç†
  timestamp: Date,         // æ™‚é–“æˆ³
  error_message: String    // éŒ¯èª¤è¨Šæ¯ (å¦‚æœ‰)
}
```

#### 3.2 `search_analytics` - æœå°‹åˆ†æè³‡æ–™
**ç”¨é€”**: è¨˜éŒ„ä½¿ç”¨è€…æœå°‹è¡Œç‚ºï¼Œç”¨æ–¼æ”¹å–„æœå°‹é«”é©—å’Œ SEO

**è³‡æ–™çµæ§‹**:
```javascript
{
  _id: ObjectId,
  search_type: String,     // æœå°‹é¡å‹ (company/tender/aitool)
  query: String,           // æœå°‹é—œéµå­—
  filters: Object,         // ç¯©é¸æ¢ä»¶
  results_count: Number,   // çµæœæ•¸é‡
  click_through: Boolean,  // æ˜¯å¦é»æ“Šçµæœ
  session_id: String,      // ä½¿ç”¨è€… session
  timestamp: Date,         // æœå°‹æ™‚é–“
  response_time: Number    // æœå°‹å›æ‡‰æ™‚é–“
}
```

## ğŸ› ï¸ è³‡æ–™åº«é€£ç·šèˆ‡è¨­å®š

### ç’°å¢ƒé…ç½®
```javascript
// .env.local
MONGODB_URI=mongodb://admin:password@localhost:27017/business-magnifier?authSource=admin

// ç”Ÿç”¢ç’°å¢ƒ
MONGODB_URI=mongodb://admin:password@mongodb.example.com:27017/business-magnifier?authSource=admin&ssl=true
```

### Mongoose é€£ç·šè¨­å®š
```javascript
// lib/database/connection.ts
import mongoose from 'mongoose';

const MONGODB_URI = process.env.MONGODB_URI!;

if (!MONGODB_URI) {
  throw new Error('è«‹åœ¨ .env.local ä¸­å®šç¾© MONGODB_URI');
}

let cached = (global as any).mongoose;

if (!cached) {
  cached = (global as any).mongoose = { conn: null, promise: null };
}

export async function connectToDatabase() {
  if (cached.conn) {
    return cached.conn;
  }

  if (!cached.promise) {
    const opts = {
      bufferCommands: false,
      maxPoolSize: 10,
      serverSelectionTimeoutMS: 5000,
      socketTimeoutMS: 45000,
    };

    cached.promise = mongoose.connect(MONGODB_URI, opts);
  }

  try {
    cached.conn = await cached.promise;
  } catch (e) {
    cached.promise = null;
    throw e;
  }

  return cached.conn;
}
```

### è³‡æ–™æ¨¡å‹ç¯„ä¾‹
```javascript
// lib/database/models/Company.ts
import mongoose from 'mongoose';

const CompanySchema = new mongoose.Schema({
  taxId: { type: String, required: true, unique: true },
  name: { type: String, required: true },
  fullName: String,
  englishName: String,
  status: String,
  chairman: String,
  industry: String,
  address: String,
  establishedDate: Date,
  financial: {
    totalCapital: String,
    paidInCapital: String,
    employees: String,
    revenue: String
  },
  contact: {
    phone: String,
    email: String,
    website: String,
    fax: String
  },
  searchKeywords: [String],
  tenderCount: { type: Number, default: 0 }
}, {
  timestamps: true,
  collection: 'companies'
});

// å»ºç«‹ç´¢å¼•
CompanySchema.index({ taxId: 1 }, { unique: true });
CompanySchema.index({ name: 'text', fullName: 'text' });
CompanySchema.index({ industry: 1 });
CompanySchema.index({ establishedDate: -1 });

export default mongoose.models.Company || mongoose.model('Company', CompanySchema);
```

## ğŸš€ è³‡æ–™åº«ç®¡ç†è…³æœ¬

### å‚™ä»½å’Œé‚„åŸ
```bash
#!/bin/bash
# scripts/backup-mongodb.sh

# å»ºç«‹å‚™ä»½ç›®éŒ„
BACKUP_DIR="./db/backups/$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR

# åŸ·è¡Œå‚™ä»½
mongodump --uri="mongodb://admin:password@localhost:27017/business-magnifier?authSource=admin" --out=$BACKUP_DIR

echo "å‚™ä»½å®Œæˆ: $BACKUP_DIR"
```

### è³‡æ–™åˆå§‹åŒ–
```javascript
// scripts/init-collections.js
const { MongoClient } = require('mongodb');

async function initializeCollections() {
  const client = new MongoClient(process.env.MONGODB_URI);
  
  try {
    await client.connect();
    const db = client.db('business-magnifier');
    
    // å»ºç«‹é›†åˆå’Œç´¢å¼•
    await db.collection('companies').createIndex({ taxId: 1 }, { unique: true });
    await db.collection('companies').createIndex({ name: "text", fullName: "text" });
    await db.collection('ai_tools').createIndex({ id: 1 }, { unique: true });
    await db.collection('pcc_api_cache').createIndex({ expires_at: 1 }, { expireAfterSeconds: 0 });
    
    console.log('Collections åˆå§‹åŒ–å®Œæˆ');
  } finally {
    await client.close();
  }
}

initializeCollections();
```

## ğŸ’¡ å°ˆå®¶å¿ƒå¾—

### è¨­è¨ˆåŸå‰‡
1. **è³‡æ–™æ­£è¦åŒ–**: é©åº¦æ­£è¦åŒ–ï¼Œé¿å…éåº¦æ­£è¦åŒ–å½±éŸ¿æŸ¥è©¢æ•ˆèƒ½
2. **ç´¢å¼•ç­–ç•¥**: åŸºæ–¼æŸ¥è©¢æ¨¡å¼å»ºç«‹ç´¢å¼•ï¼Œé¿å…å»ºç«‹éå¤šç´¢å¼•
3. **TTL ç®¡ç†**: ä½¿ç”¨ TTL ç´¢å¼•è‡ªå‹•æ¸…ç†éæœŸçš„å¿«å–è³‡æ–™
4. **å‚™ä»½ç­–ç•¥**: å®šæœŸå‚™ä»½é‡è¦è³‡æ–™ï¼Œæ¸¬è©¦é‚„åŸæµç¨‹

### æ•ˆèƒ½å„ªåŒ–å»ºè­°
1. **æŸ¥è©¢å„ªåŒ–**: ä½¿ç”¨ `explain()` åˆ†ææŸ¥è©¢è¨ˆç•«
2. **åˆ†é è™•ç†**: å¤§é‡è³‡æ–™ä½¿ç”¨éŠæ¨™åˆ†é è€Œé skip/limit
3. **èšåˆç®¡é“**: è¤‡é›œæŸ¥è©¢ä½¿ç”¨èšåˆæ¡†æ¶
4. **é€£ç·šæ± **: é©ç•¶è¨­å®šé€£ç·šæ± å¤§å°

### å®‰å…¨æ€§è€ƒé‡
1. **èªè­‰æ©Ÿåˆ¶**: å•Ÿç”¨ MongoDB èªè­‰
2. **ç¶²è·¯å®‰å…¨**: é™åˆ¶ç¶²è·¯å­˜å–ï¼Œä½¿ç”¨ SSL/TLS
3. **æ¬Šé™æ§åˆ¶**: å¯¦æ–½æœ€å°æ¬Šé™åŸå‰‡


4. **è³‡æ–™åŠ å¯†**: æ•æ„Ÿè³‡æ–™é€²è¡ŒåŠ å¯†å„²å­˜