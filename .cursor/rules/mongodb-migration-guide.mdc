---
description: **æè¿°**: å®Œæ•´çš„ MongoDB é·ç§»å¯¦æ–½æŒ‡å—ï¼Œæ¶µè“‹å¾ PostgreSQL + Prisma åˆ° MongoDB + Mongoose çš„æ¶æ§‹é·ç§»ç­–ç•¥ã€æœ¬åœ°é–‹ç™¼ç’°å¢ƒå»ºç½®ã€Docker å®¹å™¨åŒ–éƒ¨ç½²ã€AI å·¥å…·è³‡æ–™é·ç§»ã€è³‡æ–™æ¨¡å‹è¨­è¨ˆå’Œæ•ˆèƒ½å„ªåŒ–é…ç½®ã€‚æä¾›å¾ç’°å¢ƒæº–å‚™åˆ°ç”Ÿç”¢éƒ¨ç½²çš„ç³»çµ±æ€§è§£æ±ºæ–¹æ¡ˆï¼Œå°ˆæ³¨æ–¼ JSON åŸç”Ÿæ”¯æ´å’Œéˆæ´» Schema è¨­è¨ˆã€‚  **è§¸ç™¼æ¢ä»¶**:  - PostgreSQL è½‰ MongoDB è³‡æ–™åº«é·ç§»éœ€æ±‚  - Prisma è½‰ Mongoose ODM æ¶æ§‹é‡æ§‹  - æœ¬åœ° MongoDB é–‹ç™¼ç’°å¢ƒå»ºç½®  - Docker å®¹å™¨åŒ–è³‡æ–™åº«éƒ¨ç½²  - AI å·¥å…·è³‡æ–™é·ç§»å’Œç®¡ç†  - NoSQL è³‡æ–™æ¨¡å‹è¨­è¨ˆå’Œå„ªåŒ–  - MongoDB ç´¢å¼•ç­–ç•¥å’Œæ•ˆèƒ½èª¿å„ª  - è³‡æ–™åº«é€£ç·šç®¡ç†å’ŒéŒ¯èª¤è™•ç†  - ä¼æ¥­è³‡æ–™å’Œæ¨™æ¡ˆè³‡æ–™çµæ§‹è¨­è¨ˆ  - RAG åŠŸèƒ½å‘é‡æœå°‹æº–å‚™  **é—œéµè©**: `MongoDBé·ç§»`, `Prismaè½‰Mongoose`, `æœ¬åœ°é–‹ç™¼ç’°å¢ƒ`, `Dockerå®¹å™¨åŒ–`, `AIå·¥å…·é·ç§»`, `NoSQLè¨­è¨ˆ`, `è³‡æ–™æ¨¡å‹`, `ç´¢å¼•å„ªåŒ–`, `é€£ç·šç®¡ç†`, `å‘é‡æœå°‹`
globs: 
alwaysApply: false
---
# MongoDB é·ç§»æŒ‡å— ğŸš€

æœ¬æŒ‡å—å°‡å”åŠ©æ‚¨å¾ PostgreSQL + Prisma æ¶æ§‹é·ç§»åˆ° MongoDB + Mongoose æ¶æ§‹ã€‚

## ğŸ“‹ é·ç§»æ¦‚è¿°

### ç‚ºä»€éº¼é¸æ“‡ MongoDBï¼Ÿ

1. **JSON åŸç”Ÿæ”¯æ´** - ä¼æ¥­è³‡æ–™ã€æ¨™æ¡ˆè³‡æ–™æœ¬èº«å°±æ˜¯ JSON æ ¼å¼
2. **éˆæ´»çš„ Schema** - é©æ‡‰ä¸åŒä¼æ¥­çš„è³‡æ–™çµæ§‹å·®ç•°
3. **æ°´å¹³æ“´å±•** - æ”¯æ´æœªä¾† RAG åŠŸèƒ½çš„å‘é‡æœå°‹
4. **é–‹ç™¼æ•ˆç‡** - æ¸›å°‘ JSON â†” é—œè¯å¼è¡¨æ ¼çš„è½‰æ›æˆæœ¬

### é·ç§»ç¯„åœ

- âœ… **AI å·¥å…·è³‡æ–™** - 5960 è¡Œ promptTools.ts â†’ MongoDB
- âœ… **ä¼æ¥­è³‡æ–™æ¨¡å‹** - æ”¯æ´å®Œæ•´çš„ä¼æ¥­è³‡è¨Šçµæ§‹
- âœ… **æ¨™æ¡ˆè³‡æ–™æ¨¡å‹** - æ¨™æ¡ˆæŸ¥è©¢å’Œç®¡ç†
- âœ… **ä½¿ç”¨è€…å›é¥‹** - å›é¥‹æ”¶é›†å’Œåˆ†æ

## ğŸ› ï¸ é·ç§»æ­¥é©Ÿ

### ç¬¬ä¸€æ­¥ï¼šç’°å¢ƒæº–å‚™

#### 1.1 å®‰è£ MongoDB

**æœ¬åœ°é–‹ç™¼ç’°å¢ƒï¼š**
```bash
# macOS (ä½¿ç”¨ Homebrew)
brew tap mongodb/brew
brew install mongodb-community

# Windows (ä½¿ç”¨ Chocolatey)
choco install mongodb

# Ubuntu/Debian
sudo apt-get install mongodb

# å•Ÿå‹• MongoDB æœå‹™
sudo systemctl start mongod
```

**é›²ç«¯ç’°å¢ƒ (æ¨è–¦)ï¼š**
1. è¨»å†Š [MongoDB Atlas](mdc:https:/www.mongodb.com/cloud/atlas)
2. å»ºç«‹å…è²»å¢é›† (512MB å…è²»é¡åº¦)
3. è¨­å®šç¶²è·¯å­˜å–å’Œè³‡æ–™åº«ä½¿ç”¨è€…
4. å–å¾—é€£ç·šå­—ä¸²

#### 1.2 æ›´æ–°å°ˆæ¡ˆä¾è³´

```bash
cd next

# ç§»é™¤ Prisma ç›¸é—œå¥—ä»¶
npm uninstall @prisma/client prisma

# å®‰è£ MongoDB ç›¸é—œå¥—ä»¶
npm install mongoose@^8.0.3
npm install --save-dev @types/mongoose
```

#### 1.3 ç’°å¢ƒè®Šæ•¸è¨­å®š

å»ºç«‹ `.env.local`ï¼š
```env
# MongoDB é€£ç·š (æœ¬åœ°)
MONGODB_URI=mongodb://localhost:27017/business-magnifier

# MongoDB é€£ç·š (Atlas é›²ç«¯)
# MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/business-magnifier

# å…¶ä»–ç’°å¢ƒè®Šæ•¸...
GOOGLE_AI_API_KEY=your_api_key
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=your_maps_key
JWT_SECRET=your_jwt_secret
```

### ç¬¬äºŒæ­¥ï¼šè³‡æ–™åº«æ¶æ§‹å»ºç«‹

#### 2.1 é€£ç·šè¨­å®š

æª”æ¡ˆå·²å»ºç«‹ï¼š`src/lib/database/connection.ts`
- âœ… é€£ç·šæ± ç®¡ç†
- âœ… éŒ¯èª¤è™•ç†
- âœ… è‡ªå‹•é‡é€£æ©Ÿåˆ¶

#### 2.2 è³‡æ–™æ¨¡å‹å®šç¾©

**ä¼æ¥­æ¨¡å‹** (`src/lib/database/models/Company.ts`)ï¼š
```typescript
// æ”¯æ´å®Œæ•´çš„ä¼æ¥­è³‡è¨Šçµæ§‹
interface ICompany {
  taxId: string;           // çµ±ä¸€ç·¨è™Ÿ
  name: string;            // å…¬å¸åç¨±
  financial: {...};       // è²¡å‹™è³‡è¨Š
  contact: {...};          // è¯çµ¡è³‡è¨Š
  directors: [...];        // è‘£ç›£äº‹
  businessScope: [...];    // ç‡Ÿæ¥­é …ç›®
  // ... æ›´å¤šæ¬„ä½
}
```

**AI å·¥å…·æ¨¡å‹** (`src/lib/database/models/AITool.ts`)ï¼š
```typescript
// AI å·¥å…·å®šç¾©å’Œä½¿ç”¨çµ±è¨ˆ
interface IAITool {
  id: string;
  name: string;
  config: {
    instructions: {...};
    promptTemplate: {...};
  };
  usage: {
    totalUses: number;
    popularityScore: number;
  };
  // ... æ›´å¤šæ¬„ä½
}
```

### ç¬¬ä¸‰æ­¥ï¼šè³‡æ–™é·ç§»åŸ·è¡Œ

#### 3.1 AI å·¥å…·é·ç§»

```bash
# åŸ·è¡Œå®Œæ•´çš„ AI å·¥å…·é·ç§»
npm run migrate:aitools

# æˆ–æ‰‹å‹•åŸ·è¡Œ
npx ts-node src/lib/database/migration/migrateAITools.ts
```

é·ç§»éç¨‹åŒ…å«ï¼š
1. **è³‡æ–™è½‰æ›** - promptTools.ts â†’ MongoDB æ–‡æª”
2. **åˆ†é¡æ¨æ–·** - è‡ªå‹•åˆ†é¡ AI å·¥å…·
3. **ç´¢å¼•å»ºç«‹** - æœå°‹å’Œæ•ˆèƒ½å„ªåŒ–
4. **é©—è­‰æª¢æŸ¥** - ç¢ºä¿è³‡æ–™å®Œæ•´æ€§

#### 3.2 é·ç§»çµæœé©—è­‰

```bash
# æª¢æŸ¥é·ç§»çµæœ
node -e "
const { validateMigration } = require('./src/lib/database/migration/migrateAITools.ts');
validateMigration();
"
```

é æœŸè¼¸å‡ºï¼š
```
ğŸ“Š è³‡æ–™åº«çµ±è¨ˆ:
- ç¸½å·¥å…·æ•¸: 150+
- å•Ÿç”¨å·¥å…·æ•¸: 150+
- åŸå§‹å·¥å…·æ•¸: 150+

ğŸ“ˆ åˆ†é¡åˆ†å¸ƒ:
- æç¤ºè©: 45 å€‹å·¥å…·
- å¯«ä½œ: 32 å€‹å·¥å…·
- å•†æ¥­: 28 å€‹å·¥å…·
- ...

âœ… æ²’æœ‰ç™¼ç¾é‡è¤‡çš„å·¥å…· ID
```

### ç¬¬å››æ­¥ï¼šAPI è·¯ç”±æ›´æ–°

#### 4.1 ç§»é™¤ Prisma ç›¸é—œç¨‹å¼ç¢¼

```bash
# æœå°‹ä¸¦æ›¿æ› Prisma ç›¸é—œå¼•ç”¨
grep -r "prisma" src/ --include="*.ts" --include="*.tsx"
```

#### 4.2 æ›´æ–° API è·¯ç”±

**ä¼æ¥­ API ç¯„ä¾‹**ï¼š
```typescript
// src/app/api/company/[id]/route.ts
import connectToDatabase from '@/lib/database/connection';
import Company from '@/lib/database/models/Company';

export async function GET(request: Request, { params }: { params: { id: string } }) {
  try {
    await connectToDatabase();
    
    const company = await Company.findByTaxId(params.id);
    
    if (!company) {
      return NextResponse.json({ error: 'ä¼æ¥­ä¸å­˜åœ¨' }, { status: 404 });
    }
    
    return NextResponse.json(company);
  } catch (error) {
    return NextResponse.json({ error: 'æŸ¥è©¢å¤±æ•—' }, { status: 500 });
  }
}
```

**AI å·¥å…· API ç¯„ä¾‹**ï¼š
```typescript
// src/app/api/aitool/route.ts
import AITool from '@/lib/database/models/AITool';

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const category = searchParams.get('category');
  const query = searchParams.get('q');
  
  const tools = await AITool.searchTools(query || '', { category });
  return NextResponse.json(tools);
}
```

### ç¬¬äº”æ­¥ï¼šå‰ç«¯å…ƒä»¶æ›´æ–°

#### 5.1 æ›´æ–°è³‡æ–™ç²å–é‚è¼¯

```typescript
// èˆŠç‰ˆ (Prisma)
const company = await prisma.company.findUnique({
  where: { uniformNumber: taxId }
});

// æ–°ç‰ˆ (MongoDB)
const company = await Company.findByTaxId(taxId);
```

#### 5.2 æ›´æ–°å‹åˆ¥å®šç¾©

```typescript
// src/types/database.ts
export interface CompanyDocument extends ICompany {
  _id: string;
  displayName: string;  // è™›æ“¬æ¬„ä½
  isListed: boolean;    // è™›æ“¬æ¬„ä½
}
```

### ç¬¬å…­æ­¥ï¼šç´¢å¼•å„ªåŒ–

#### 6.1 å»ºç«‹æœå°‹ç´¢å¼•

```javascript
// MongoDB Shell æŒ‡ä»¤
db.companies.createIndex({ "taxId": 1 }, { unique: true })
db.companies.createIndex({ "name": "text", "fullName": "text" })
db.companies.createIndex({ "searchKeywords": 1 })

db.aitools.createIndex({ "id": 1 }, { unique: true })
db.aitools.createIndex({ "category": 1, "isActive": 1 })
db.aitools.createIndex({ "usage.popularityScore": -1 })
```

#### 6.2 æ•ˆèƒ½ç›£æ§

```typescript
// å•Ÿç”¨ MongoDB æŸ¥è©¢åˆ†æ
mongoose.set('debug', process.env.NODE_ENV === 'development');
```

## ğŸ§ª æ¸¬è©¦èˆ‡é©—è­‰

### æ¸¬è©¦æ¸…å–®

- [ ] **é€£ç·šæ¸¬è©¦** - MongoDB é€£ç·šæ­£å¸¸
- [ ] **è³‡æ–™é·ç§»** - AI å·¥å…·è³‡æ–™å®Œæ•´é·ç§»
- [ ] **API åŠŸèƒ½** - æ‰€æœ‰ API è·¯ç”±æ­£å¸¸é‹ä½œ
- [ ] **æœå°‹åŠŸèƒ½** - ä¼æ¥­å’Œ AI å·¥å…·æœå°‹æ­£å¸¸
- [ ] **æ•ˆèƒ½æ¸¬è©¦** - æŸ¥è©¢é€Ÿåº¦ç¬¦åˆé æœŸ

### æ¸¬è©¦æŒ‡ä»¤

```bash
# é€£ç·šæ¸¬è©¦
npm run test:db-connection

# API æ¸¬è©¦
npm run test:api

# æ•´åˆæ¸¬è©¦
npm run test:integration
```

## ğŸš€ éƒ¨ç½²æŒ‡å—

### Netlify éƒ¨ç½²

1. **ç’°å¢ƒè®Šæ•¸è¨­å®š**ï¼š
   ```
   MONGODB_URI=mongodb+srv://...
   GOOGLE_AI_API_KEY=...
   NODE_ENV=production
   ```

2. **å»ºç½®è¨­å®š**ï¼š
   ```toml
   # netlify.toml
   [build]
     command = "npm run build"
     publish = ".next"
   
   [[plugins]]
     package = "@netlify/plugin-nextjs"
   ```

### Vercel éƒ¨ç½²

```bash
# å®‰è£ Vercel CLI
npm i -g vercel

# éƒ¨ç½²
vercel --prod

# è¨­å®šç’°å¢ƒè®Šæ•¸
vercel env add MONGODB_URI
```

## ğŸ“Š æ•ˆèƒ½å„ªåŒ–å»ºè­°

### 1. ç´¢å¼•ç­–ç•¥

```javascript
// è¤‡åˆç´¢å¼• - æå‡è¤‡é›œæŸ¥è©¢æ•ˆèƒ½
db.companies.createIndex({ 
  "industry": 1, 
  "financial.paidInCapital": -1 
})

// æ–‡å­—æœå°‹ç´¢å¼• - æå‡æœå°‹æ•ˆèƒ½
db.companies.createIndex({
  "name": "text",
  "fullName": "text",
  "searchKeywords": "text"
})
```

### 2. æŸ¥è©¢å„ªåŒ–

```typescript
// ä½¿ç”¨æŠ•å½±æ¸›å°‘è³‡æ–™å‚³è¼¸
const companies = await Company.find(query)
  .select('taxId name address financial.paidInCapital')
  .limit(20);

// ä½¿ç”¨èšåˆç®¡é“é€²è¡Œè¤‡é›œæŸ¥è©¢
const stats = await Company.aggregate([
  { $match: { status: 'æ ¸å‡†è¨­ç«‹' } },
  { $group: { _id: '$industry', count: { $sum: 1 } } },
  { $sort: { count: -1 } }
]);
```

### 3. å¿«å–ç­–ç•¥

```typescript
// Redis å¿«å– (å¯é¸)
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL);

// å¿«å–ç†±é–€æŸ¥è©¢
const cacheKey = `company:${taxId}`;
let company = await redis.get(cacheKey);

if (!company) {
  company = await Company.findByTaxId(taxId);
  await redis.setex(cacheKey, 3600, JSON.stringify(company));
}
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

**1. é€£ç·šå¤±æ•—**
```
Error: MongoNetworkError: failed to connect to server
```
è§£æ±ºæ–¹æ¡ˆï¼š
- æª¢æŸ¥ `MONGODB_URI` æ˜¯å¦æ­£ç¢º
- ç¢ºèªç¶²è·¯é€£ç·šå’Œé˜²ç«ç‰†è¨­å®š
- æª¢æŸ¥ MongoDB Atlas ç™½åå–®è¨­å®š

**2. ç´¢å¼•å»ºç«‹å¤±æ•—**
```
Error: Index with name already exists
```
è§£æ±ºæ–¹æ¡ˆï¼š
```javascript
// åˆªé™¤ç¾æœ‰ç´¢å¼•
db.companies.dropIndex("name_text_fullName_text")
// é‡æ–°å»ºç«‹ç´¢å¼•
db.companies.createIndex({ "name": "text", "fullName": "text" })
```

**3. è¨˜æ†¶é«”ä½¿ç”¨éé«˜**
```
Error: JavaScript heap out of memory
```
è§£æ±ºæ–¹æ¡ˆï¼š
```bash
# å¢åŠ  Node.js è¨˜æ†¶é«”é™åˆ¶
NODE_OPTIONS="--max-old-space-size=4096" npm run dev
```

### ç›£æ§å’Œæ—¥èªŒ

```typescript
// å•Ÿç”¨è©³ç´°æ—¥èªŒ
mongoose.set('debug', true);

// ç›£æ§æ…¢æŸ¥è©¢
mongoose.connection.on('slow', (query) => {
  console.warn('æ…¢æŸ¥è©¢:', query);
});
```

## ğŸ“ˆ æœªä¾†æ“´å±•

### RAG åŠŸèƒ½æº–å‚™

```typescript
// AI å·¥å…·å‘é‡åŒ– (æœªä¾†åŠŸèƒ½)
interface IAITool {
  // ... ç¾æœ‰æ¬„ä½
  embedding?: number[];  // 768 ç¶­å‘é‡
  semanticTags?: string[]; // èªç¾©æ¨™ç±¤
}

// å‘é‡æœå°‹ (MongoDB Atlas Vector Search)
const similarTools = await AITool.aggregate([
  {
    $vectorSearch: {
      index: "vector_index",
      path: "embedding",
      queryVector: userQueryVector,
      numCandidates: 100,
      limit: 10
    }
  }
]);
```

### åˆ†æåŠŸèƒ½

```typescript
// ä½¿ç”¨çµ±è¨ˆåˆ†æ
const popularTools = await AITool.aggregate([
  { $match: { isActive: true } },
  { $sort: { "usage.totalUses": -1 } },
  { $limit: 10 }
]);

// ä¼æ¥­è³‡æ–™åˆ†æ
const industryStats = await Company.aggregate([
  { $group: { 
    _id: "$industry", 
    count: { $sum: 1 },
    avgCapital: { $avg: "$financial.paidInCapital" }
  }}
]);
```

## âœ… é·ç§»æª¢æŸ¥æ¸…å–®

- [ ] MongoDB ç’°å¢ƒå»ºç½®å®Œæˆ
- [ ] ä¾è³´å¥—ä»¶æ›´æ–°å®Œæˆ
- [ ] è³‡æ–™æ¨¡å‹å»ºç«‹å®Œæˆ
- [ ] AI å·¥å…·è³‡æ–™é·ç§»å®Œæˆ
- [ ] API è·¯ç”±æ›´æ–°å®Œæˆ
- [ ] å‰ç«¯å…ƒä»¶æ›´æ–°å®Œæˆ
- [ ] ç´¢å¼•å»ºç«‹å®Œæˆ
- [ ] æ¸¬è©¦é€šé
- [ ] éƒ¨ç½²è¨­å®šå®Œæˆ
- [ ] æ•ˆèƒ½ç›£æ§è¨­å®šå®Œæˆ

---

ğŸ‰ **æ­å–œï¼æ‚¨å·²æˆåŠŸå®Œæˆ MongoDB é·ç§»ï¼**



ç¾åœ¨æ‚¨å¯ä»¥äº«å— MongoDB å¸¶ä¾†çš„éˆæ´»æ€§å’Œæ•ˆèƒ½å„ªå‹¢ï¼Œç‰¹åˆ¥æ˜¯åœ¨è™•ç† JSON è³‡æ–™å’Œæœªä¾†çš„ RAG åŠŸèƒ½æ“´å±•æ–¹é¢ã€‚