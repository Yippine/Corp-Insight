# Story 1.1: Google OAuth 基礎設定與 NextAuth.js 整合

## Status

Approved

## Story

**As a** 系統管理員，
**I want** 配置 Google OAuth 應用程式和 NextAuth.js，
**so that** 用戶可以使用 Google 帳號登入系統。

## Acceptance Criteria

1. Google Cloud Console OAuth 應用程式設定完成 (含安全限制設定)
2. NextAuth.js 配置檔包含 Google provider 設定 (含安全參數)
3. 環境變數設定 (GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET)
4. OAuth callback URL 正確配置
5. 基本的 Google 登入按鈕顯示 (含載入狀態)
6. OAuth 錯誤處理機制正常運作 (網路錯誤、認證失敗等)
7. 登入成功後正確導向至指定頁面

## Tasks / Subtasks

- [ ] 設定 Google Cloud Console OAuth 應用程式 (AC: 1)
  - [ ] 建立新的 Google Cloud Project 或使用現有專案
  - [ ] 啟用 Google+ API 和 OAuth 同意畫面
  - [ ] 設定 OAuth 2.0 Client ID (Web application type)
  - [ ] 配置授權的重新導向 URI
  - [ ] 設定安全限制 (網域限制、HTTPS 強制要求)
  - [ ] 配置 OAuth 同意畫面的隱私權政策和使用條款
- [ ] 安裝並配置 NextAuth.js (AC: 2, 3)
  - [ ] 安裝 `next-auth@^4.24.0` 套件 (確保 Next.js 14 App Router 相容性)
  - [ ] 建立 NextAuth.js 配置檔案 `/src/app/api/auth/[...nextauth]/route.ts`
  - [ ] 設定 Google provider 配置與安全參數 (PKCE, state, nonce)
  - [ ] 配置環境變數 GOOGLE_CLIENT_ID 和 GOOGLE_CLIENT_SECRET
  - [ ] 設定 JWT 和 Session 策略 (Access JWT 15分鐘，Refresh Token 存 DB)
- [ ] 實作 OAuth callback 處理 (AC: 4)
  - [ ] 設定 NextAuth callback URLs
  - [ ] 驗證 callback 路由正確運作
  - [ ] 測試 OAuth 重新導向流程
  - [ ] 實作錯誤處理 (網路錯誤、認證失敗、權限拒絕)
- [ ] 建立基本登入 UI (AC: 5)
  - [ ] 設計 Google 登入按鈕元件 (含載入狀態與視覺回饋)
  - [ ] 整合 NextAuth signIn 功能
  - [ ] 確保按鈕顯示在適當位置
  - [ ] 實作登入成功後的導向邏輯
- [ ] 整合測試與驗證 (依據測試標準)
  - [ ] OAuth 流程整合測試 (成功與失敗情境)
  - [ ] NextAuth 配置驗證測試
  - [ ] 登入按鈕元件單元測試
  - [ ] Callback 路由處理測試
  - [ ] 錯誤處理機制測試

## Dev Notes

### 前一個故事見解

無（這是第一個故事）

### 架構與技術脈絡

#### 技術堆疊 [Source: next/CLAUDE.md#技術堆疊]

- **前端**: Next.js 14 搭配 React 18、TypeScript、Tailwind CSS
- **後端**: Next.js API 路由搭配 MongoDB (Mongoose)
- **資料庫**: MongoDB 含連線池管理
- **UI 元件**: Radix UI、客製化 shadcn/ui 元件

#### 認證系統架構 [Source: next/docs/features/membership-system/architecture/project-document-architecture-membership-auth.md#認證系統]

- **NextAuth.js 整合**: OAuth 流程、Credentials providers、Session/JWT 策略、callback hooks
- **Integration point**: `/api/auth/*` routes；callback 需呼叫 user service
- **安全要求**: OAuth with PKCE, state, nonce
- **Token 策略**: Access JWT 短存活（建議 15 分鐘）、Refresh Token 存 DB

#### 資料模型 [Source: next/docs/features/membership-system/architecture/subsystems/architecture-subsystem-auth.md#MongoDB Collections]

- `users` - 用戶基本資料
- `user_auth_providers` - 第三方登入綁定
- `refresh_tokens` - Refresh token 存儲
- `audit_logs` - OAuth 活動記錄

#### API 端點 [Source: next/docs/features/membership-system/epics/epic-1-google-oauth.md#API端點]

- `GET /api/auth/signin/google` - 發起 Google OAuth
- `GET /api/auth/callback/google` - Google OAuth callback
- `GET /api/auth/providers` - 取得可用 provider 列表

#### 檔案位置與專案結構 [Source: 專案結構檢查]

- **NextAuth 配置**: `/src/app/api/auth/[...nextauth]/route.ts`
- **UI 元件**: `/src/components/` (遵循現有元件結構)
- **登入頁面**: 整合到現有導航結構
- **環境配置**: 根目錄 `.env.local` 或 `.env.production`

#### Brownfield 開發約束 [Source: next/docs/BROWNFIELD-DEVELOPMENT-CONSTRAINTS.md]

- **絕不修改** 任何既有程式碼、API、資料庫、頁面
- **僅允許新增** 新功能相關內容
- **必須遵循** 既有架構與編碼風格
- **確保** 既有功能正常運作

#### 技術約束

- **授權要求**: 套件需為 MIT 或 Apache-2.0 授權
- **NextAuth.js 版本**: 使用 v4.24.0+ 確保 Next.js 14 App Router 完整支援
- **資料庫**: MongoDB (Docker) with replica set 建議用於 transactions
- **部署**: Next.js standalone 模式，Docker 容器化
- **安全要求**: OAuth with PKCE, state, nonce 參數強制啟用

#### Testing [Source: package.json 分析]

**測試框架設定:**
- 專案目前**未設定專用測試框架**，依賴 Next.js 內建測試能力
- 使用 TypeScript + ESLint 進行靜態檢查
- 建議使用 Next.js 14 App Router 原生測試模式

**測試策略:**
- **配置測試**: NextAuth.js 設定檔語法驗證
- **整合測試**: OAuth 完整流程測試 (手動驗證)
- **元件測試**: 登入按鈕在瀏覽器環境測試
- **API 路由測試**: Callback 端點回應測試
- **錯誤情境測試**: 失敗情境的錯誤處理驗證

**測試檔案位置:**
- 在對應功能目錄建立 `__tests__` 資料夾
- 檔案命名：`[功能名稱].test.ts` 
- 整合測試：在根目錄 `tests/` 目錄（需新建）

**測試執行方式:**
- 開發時期：瀏覽器手動測試為主
- 未來擴充：考慮引入 Jest 或 Vitest 自動化測試

## Change Log

| Date       | Version | Description                                       | Author              |
| ---------- | ------- | ------------------------------------------------- | ------------------- |
| 2025-08-20 | 1.0     | 初始故事建立                                      | Scrum Master (BMad) |
| 2025-08-20 | 1.1     | 修復驗證問題：安全設定、錯誤處理、測試框架明確化 | Product Owner (Sarah) |

## Dev Agent Record

_此區塊將由開發代理在實作時填入_

### Agent Model Used

_待開發代理填入_

### Debug Log References

_待開發代理填入_

### Completion Notes List

_待開發代理填入_

### File List

_待開發代理填入_

## QA Results

_此區塊將由 QA 代理在完成後填入_
