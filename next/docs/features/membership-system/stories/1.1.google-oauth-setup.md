# Story 1.1: Google OAuth 基礎設定與 NextAuth.js 整合

## Status
Approved

## Story
**As a** 系統管理員，
**I want** 配置 Google OAuth 應用程式和 NextAuth.js 整合，
**so that** 用戶可以使用 Google 帳號登入系統。

## Acceptance Criteria
1. Google Cloud Console OAuth 應用程式設定完成
2. NextAuth.js 配置檔包含 Google provider 設定
3. 環境變數設定 (GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET)
4. OAuth callback URL 正確配置
5. 基本的 Google 登入按鈕顯示

## Tasks / Subtasks

- [ ] **環境準備與套件安裝** (AC: 1, 2)
  - [ ] 安裝 next-auth 套件 (確認 MIT 授權)
  - [ ] 安裝 payload 套件 (確認 MIT 授權)
  - [ ] 確認 Node.js 21 和 Docker 環境正常
  - [ ] 驗證 MongoDB Docker 容器運行狀態

- [ ] **Google Cloud Console 設定** (AC: 1, 4)
  - [ ] 建立或使用現有的 Google Cloud Project
  - [ ] 啟用 Google+ API 或 Google Identity API
  - [ ] 建立 OAuth 2.0 客戶端 ID (Web 應用程式類型)
  - [ ] 設定授權的重定向 URI: `http://localhost:3000/api/auth/callback/google`
  - [ ] 設定授權的 JavaScript 來源: `http://localhost:3000`
  - [ ] 記錄 Client ID 和 Client Secret

- [ ] **NextAuth.js 基礎配置** (AC: 2, 3)
  - [ ] 建立 `src/app/api/auth/[...nextauth]/route.ts` API route
  - [ ] 配置 Google Provider 並設定必要的 scopes: `openid email profile`
  - [ ] 設定 JWT 策略基礎配置
  - [ ] 設定 session 策略與 database adapter 準備
  - [ ] 建立 NextAuth 設定檔結構

- [ ] **環境變數配置** (AC: 3)
  - [ ] 在 `.env.local` 中新增 `GOOGLE_CLIENT_ID`
  - [ ] 在 `.env.local` 中新增 `GOOGLE_CLIENT_SECRET`
  - [ ] 設定 `NEXTAUTH_SECRET` (隨機生成)
  - [ ] 設定 `NEXTAUTH_URL=http://localhost:3000`
  - [ ] 確保環境變數不會被 git 追蹤

- [ ] **MongoDB 設定準備** (AC: 1, 2)
  - [ ] 建立/確認 MongoDB replica set 設定
  - [ ] 修改 `docker-compose.yml` 加入 replica set 初始化
  - [ ] 建立 `./docker/mongodb/init` 目錄和初始化腳本
  - [ ] 測試 MongoDB transactions 支援

- [ ] **前端登入介面準備** (AC: 5)
  - [ ] 建立基本的 `/auth/signin` 頁面結構
  - [ ] 新增 Google 登入按鈕元件
  - [ ] 整合 NextAuth `signIn` 函數
  - [ ] 加入基本的載入狀態處理

- [ ] **基礎測試與驗證** (AC: 1-5)
  - [ ] 驗證 NextAuth API routes 正常回應
  - [ ] 測試 Google OAuth 授權流程啟動
  - [ ] 確認環境變數正確載入
  - [ ] 驗證 MongoDB 連線正常

## Dev Notes

### 前一個故事的洞察
無前一個故事 - 這是 Epic 1 的第一個故事。

### 技術架構脈絡
**現有系統：**
- Next.js 應用程式架構已建立 (src/app/ 結構)
- MongoDB Docker 容器已配置但需升級為 replica set
- 現有 API routes 在 `src/app/api/` 目錄下
- [Source: architecture/system-overview-scope.md#技術架構範圍]

### NextAuth.js 整合要求
**配置需求：**
- 使用 `src/app/api/auth/[...nextauth]/route.ts` 作為 API Routes
- JWT 策略支援自定欄位擴展
- Session 策略與 database adapter 整合
- Google Provider 設定 scopes: `openid email profile`
- [Source: architecture/development-handoff.md#NextAuth.js整合確認]

### Google OAuth 設定規範
**OAuth 流程設計：**
- 採用 Authorization Code Flow with PKCE
- 必須驗證 state 參數防止 CSRF
- 必須驗證 nonce 防止重放攻擊
- Callback URL 格式: `/api/auth/callback/google`
- [Source: prd/oauth-requirements.md#OAuth流程設計]

### 環境變數需求
**必要環境變數：**
- `GOOGLE_CLIENT_ID` - Google OAuth 客戶端 ID
- `GOOGLE_CLIENT_SECRET` - Google OAuth 客戶端密鑰
- `NEXTAUTH_SECRET` - NextAuth.js JWT 簽章密鑰
- `NEXTAUTH_URL` - 應用程式基礎 URL
- [Source: architecture/development-handoff.md#環境變數調查]

### MongoDB Replica Set 需求
**資料庫設定：**
- 升級現有 MongoDB 為 replica set (single-node)
- 支援 transactions 功能 (NextAuth database adapter 需求)
- 修改 `docker-compose.yml` 加入初始化腳本
- [Source: architecture/development-handoff.md#MongoDB Replica Set 設定]

### 專案結構對齊
**檔案位置規範：**
- API routes: `src/app/api/auth/[...nextauth]/route.ts`
- Auth pages: `src/app/auth/signin/page.tsx`
- NextAuth 配置: 可整合於 API route 或獨立配置檔
- 環境變數: `.env.local` (開發) / `.env.production` (生產)
- [Source: 現有專案結構分析]

### 安全考量
**授權與安全：**
- 所有新套件必須為 MIT 或 Apache-2.0 授權
- 不可硬編碼任何敏感資訊於 repository
- 環境變數必須被 `.gitignore` 排除
- [Source: architecture/development-handoff.md#絕對禁止事項]

### 相容性要求
**Brownfield 限制：**
- 不可改動現有 Dockerfile/docker-compose 架構
- API 路徑使用 `/api/auth/*` 範圍避免衝突
- 不可破壞現有 Next.js 應用架構
- [Source: architecture/system-overview-scope.md#Brownfield限制與相容性]

## Testing

### Testing Standards
**測試檔案位置：** 測試檔案應放置於 `__tests__/` 或與源文件同目錄的 `.test.ts` 檔案
**測試框架：** 基於現有專案結構，使用 Jest + React Testing Library
**測試要求：**
- 環境變數載入測試
- NextAuth 配置驗證測試
- Google Provider 設定測試
- API route 基本回應測試

### 特定測試案例
- OAuth 授權流程啟動測試
- 環境變數正確性驗證
- MongoDB 連線與 transactions 支援測試
- Google 登入按鈕互動測試

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-15 | 1.0 | 初始故事創建 - Google OAuth 基礎設定與 NextAuth.js 整合 | Scrum Master |

## Dev Agent Record
*此區塊將由開發代理在實作過程中填寫*

### Agent Model Used
*待開發代理填寫*

### Debug Log References
*待開發代理填寫*

### Completion Notes List
*待開發代理填寫*

### File List
*待開發代理填寫*

## QA Results
*此區塊將由 QA 代理在完成故事實作審查後填寫*
