# Story 1.2: Google OAuth 認證流程實作

## Status

Approved

## Story

**As a** 一般使用者，
**I want** 點擊 "Google 登入" 按鈕後能順利完成認證，
**so that** 我能夠安全地登入系統並存取所有功能。

## Acceptance Criteria

1. 完整的 Authorization Code Flow with PKCE
2. 正確的 state, nonce, PKCE 驗證
3. Google 用戶資料取得 (email, name, email_verified)
4. ID token 和 access token 驗證
5. 安全的 callback 處理

## Tasks / Subtasks

- [ ] 增強現有 OAuth 認證流程實作 (AC: 1, 2)
  - [ ] 驗證 NextAuth.js PKCE 自動處理是否正確啟用
  - [ ] 檢查 state 參數產生與驗證機制
  - [ ] 確認 nonce 參數在 ID token 驗證中正確使用
  - [ ] 實作 Authorization Code 流程的完整錯誤處理
  - [ ] 加強 callback route 的安全驗證機制
- [ ] 強化 Google 用戶資料處理 (AC: 3)
  - [ ] 擴展用戶 profile 資料取得邏輯 (email, name, email_verified)
  - [ ] 實作 email_verified 狀態檢查與處理
  - [ ] 增加用戶頭像 (picture) 與其他 profile 資料處理
  - [ ] 實作當 email 未驗證時的處理流程
  - [ ] 建立用戶資料更新與同步機制
- [ ] 完善 Token 驗證與管理 (AC: 4)
  - [ ] 實作 ID token 簽章驗證
  - [ ] 加強 access token 有效性檢查
  - [ ] 實作 token 過期自動重新整理機制
  - [ ] 建立 token 安全存儲與管理
  - [ ] 實作 token 撤銷機制
- [ ] 優化 callback 安全處理 (AC: 5)
  - [ ] 強化 callback URL 驗證與 CSRF 防護
  - [ ] 實作錯誤 callback 的適當處理
  - [ ] 加強登入成功後的導向邏輯
  - [ ] 實作登入失敗的回滾機制
  - [ ] 建立 callback 處理的審計日誌
- [ ] 整合測試與驗證 (依據測試標準)
  - [ ] 完整 OAuth 流程整合測試 (成功與失敗情境)
  - [ ] PKCE 參數驗證測試
  - [ ] State 與 nonce 安全參數測試
  - [ ] Token 驗證與管理測試
  - [ ] Callback 安全處理測試
  - [ ] 各種錯誤情境的處理測試

## Dev Notes

### 前一個故事見解

從 Story 1.1 Google OAuth 基礎設定與 NextAuth.js 整合中學到的重要見解：

- **NextAuth.js v4.24.11** 已成功安裝，Google provider 基礎配置已完成
- **Google+ API 已退役** - 無需額外 API 啟用，只需 OAuth 2.0 基本流程
- **安全參數自動處理** - NextAuth.js 自動處理 PKCE, state, nonce 參數
- **基本登入 UI** - GoogleSignInButton 元件已建立，含載入狀態處理
- **錯誤處理架構** - 基本錯誤頁面已建立，支援 32 種錯誤情境
- **環境配置完成** - GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, NEXTAUTH_SECRET 已設定
- **測試頁面建立** - /auth/test 整合測試頁面可用於驗證流程

### 架構與技術脈絡

#### 技術堆疊 [Source: next/CLAUDE.md#技術堆疊]

- **前端**: Next.js 14 搭配 React 18、TypeScript、Tailwind CSS
- **後端**: Next.js API 路由搭配 MongoDB (Mongoose)
- **資料庫**: MongoDB 含連線池管理
- **UI 元件**: Radix UI、客製化 shadcn/ui 元件

#### NextAuth.js 整合架構 [Source: project-document-architecture-membership-auth.md#核心組件與責任]

- **NextAuth.js 職責**: OAuth 流程、Credentials providers、Session/JWT 策略、callback hooks
- **Integration point**: `/api/auth/*` routes；callback 需呼叫 user service
- **安全要求**: OAuth with PKCE, state, nonce 自動處理
- **Token 策略**: Access JWT 短存活（建議 15 分鐘）、Refresh Token 存 DB

#### OAuth 認證流程設計 [Source: project-document-architecture-membership-auth.md#資料流]

**標準 OAuth 流程：**

1. Client -> `/api/auth/signin/google` (NextAuth initiates auth request)
2. Google -> callback -> `/api/auth/callback/google`
3. NextAuth callback -> fetch profile (email, email_verified)
4. 根據 email_verified 狀態進行處理：
   - `email_verified: true` -> lookup user by email, 若存在則綁定 provider, 若不存在則建立新用戶
   - `email_verified: false` -> 建立 pending_social_registration, 導向完成 email 驗證流程

#### 資料模型 [Source: architecture-subsystem-auth.md#MongoDB Collections]

相關的 MongoDB Collections：

- `users` - 用戶基本資料
- `user_auth_providers` - 第三方登入綁定記錄
- `refresh_tokens` - Refresh token 存儲
- `pending_social_registrations` - 待完成社交註冊
- `audit_logs` - OAuth 活動記錄

#### API 端點架構 [Source: epic-1-google-oauth.md#API 端點]

- `GET /api/auth/signin/google` - 發起 Google OAuth (已實作)
- `GET /api/auth/callback/google` - Google OAuth callback (需強化)
- `GET /api/auth/providers` - 取得可用 provider 列表

#### 檔案位置與專案結構

**NextAuth 配置**: `/src/app/api/auth/[...nextauth]/route.ts` (已存在，需強化)
**認證元件**: `/src/components/auth/` 目錄

- `GoogleSignInButton.tsx` (已存在)
- `SessionProvider.tsx` (已存在)
  **測試頁面**: `/src/app/auth/test/page.tsx` (已存在)
  **錯誤處理**: `/src/app/auth/error/page.tsx` (已存在)

#### 安全架構要求 [Source: project-document-architecture-membership-auth.md#安全合規]

- **OAuth 安全參數**: PKCE, state, nonce (NextAuth.js 自動處理)
- **Token 安全**: Server-side refresh token store, token rotation
- **CSRF 防護**: Cookie-based flows 的 CSRF protection
- **Session 加密**: NEXTAUTH_SECRET 用於 session 加密

#### Brownfield 開發約束 [Source: BROWNFIELD-DEVELOPMENT-CONSTRAINTS.md]

- **絕不修改** 任何既有程式碼、API、資料庫、頁面
- **僅允許新增** 新功能相關內容
- **必須遵循** 既有架構與編碼風格
- **確保** 既有功能正常運作

#### UI/UX 設計規範 [Source: ui-ux-design-specifications.md]

- **設計原則**: 沿用既有專案視覺語言，使用既有 Tailwind CSS 設計風格
- **載入狀態**: 使用既有的載入指示器，防止重複提交
- **錯誤處理**: 使用既有的錯誤處理模式
- **動畫效果**: 使用既有的過場動畫和微互動設計

### Testing

#### 測試框架設定 [Source: Story 1.1 Dev Notes]

**專案目前設定:**

- 專案目前**未設定專用測試框架**，依賴 Next.js 內建測試能力
- 使用 TypeScript + ESLint 進行靜態檢查
- 建議使用 Next.js 14 App Router 原生測試模式

**測試策略:**

- **OAuth 流程測試**: 完整的 Authorization Code Flow 測試 (手動驗證)
- **安全參數測試**: PKCE, state, nonce 參數正確性驗證
- **Token 驗證測試**: ID token 和 access token 驗證機制測試
- **Callback 處理測試**: 各種 callback 情境的處理測試
- **錯誤情境測試**: 失敗情境的錯誤處理驗證

**測試檔案位置:**

- 在對應功能目錄建立 `__tests__` 資料夾
- 檔案命名：`[功能名稱].test.ts`
- 整合測試：使用現有的 `/auth/test` 頁面

**測試執行方式:**

- 開發時期：瀏覽器手動測試為主
- 使用既有的 `/auth/test` 測試頁面進行整合驗證
- 未來擴充：考慮引入 Jest 或 Vitest 自動化測試

## Change Log

| Date       | Version | Description                       | Author             |
| ---------- | ------- | --------------------------------- | ------------------ |
| 2025-08-21 | 1.0     | 初始故事建立 - OAuth 認證流程實作 | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_待開發階段填入_

### Debug Log References

_待開發階段填入_

### Completion Notes List

_待開發階段填入_

### File List

_待開發階段填入_

## QA Results

_待 QA 階段填入_
