# AI å·¥å…·èŠå¤©è³‡æ–™æµ

```mermaid
flowchart TD
    Start["ğŸ‘¤ ä½¿ç”¨è€…è¼¸å…¥è¨Šæ¯"] --> Component["ChatbotWrapper<br/>(çµ„ä»¶)"]
    Component --> Hook["useGeminiStream<br/>(React Hook)"]
    Hook --> API["/api/gemini/stream<br/>(API ç«¯é»)"]
    API --> ServerFunc["gemini.server.ts<br/>streamGenerateContent()"]

    ServerFunc --> KeyPoolSystem["ğŸ”‘ é‡‘é‘°æ± èˆ‡æ–·è·¯å™¨ç³»çµ±"]

    subgraph KeyPoolSystem["ğŸ”‘ é‡‘é‘°æ± èˆ‡æ–·è·¯å™¨ç³»çµ±"]
        direction TB
        Step1["1ï¸âƒ£ getApiKeyPool()<br/>å–å¾—ç’°å¢ƒé‡‘é‘°æ± "]
        Step2["2ï¸âƒ£ getApiKeyStrategy()<br/>é¸æ“‡ç­–ç•¥ (Failover/Round-Robin)"]
        Step3["3ï¸âƒ£ checkKeyState()<br/>æª¢æŸ¥é‡‘é‘°å¥åº·ç‹€æ…‹"]
        Step4["4ï¸âƒ£ attemptApiCall()<br/>åŸ·è¡Œ API å‘¼å«"]
        Step5["5ï¸âƒ£ updateKeyState()<br/>æ›´æ–°é‡‘é‘°ç‹€æ…‹"]

        Step1 --> Step2
        Step2 --> Step3
        Step3 --> Step4
        Step4 --> Step5
    end

    KeyPoolSystem --> GeminiAPI["ğŸ¤– Google Generative AI<br/>(Gemini 2.5 Flash)"]
    GeminiAPI --> Stream["ä¸²æµå›æ‡‰<br/>(Server-Sent Events)"]
    Stream --> Frontend["å‰ç«¯é€å­—é¡¯ç¤º"]
    Frontend --> End["âœ… å®Œæˆå°è©±"]

    classDef userClass fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef componentClass fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef hookClass fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef apiClass fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef systemClass fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    classDef aiClass fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef streamClass fill:#e1f5fe,stroke:#01579b,stroke-width:2px

    class Start,End userClass
    class Component componentClass
    class Hook hookClass
    class API apiClass
    class ServerFunc,Step1,Step2,Step3,Step4,Step5 systemClass
    class GeminiAPI aiClass
    class Stream,Frontend streamClass
```
