# AI å·¥å…·æç¤ºè©å„ªåŒ–æµç¨‹

```mermaid
flowchart TD
    Start["ğŸ¯ æç¤ºè©å„ªåŒ–è«‹æ±‚<br/>/api/prompt/optimize"] --> ValidateReq{"é©—è­‰è«‹æ±‚åƒæ•¸<br/>toolId, type, philosophy, framework"}

    ValidateReq -->|ç¼ºå°‘åƒæ•¸| Error400["è¿”å› 400 éŒ¯èª¤"]
    ValidateReq -->|å®Œæ•´| LoadTemplate["ğŸ“– è¼‰å…¥å…ƒæç¤ºè©ç¯„æœ¬<br/>from prompt_templates"]

    LoadTemplate --> TemplateType{"ç¯„æœ¬é¡å‹?"}
    TemplateType -->|system| SysTemplate["template_optimizer"]
    TemplateType -->|prefix/suffix| AffixTemplate["prefix_optimizer / suffix_optimizer"]

    SysTemplate --> QueryDB["ğŸ” æŸ¥è©¢å·¥å…·è³‡æ–™<br/>AIToolModel.getById"]
    AffixTemplate --> QueryDB

    QueryDB --> ToolExists{"å·¥å…·å­˜åœ¨?"}
    ToolExists -->|å¦| Error404["è¿”å› 404 éŒ¯èª¤"]
    ToolExists -->|æ˜¯| BuildContext["ğŸ—ï¸ å»ºç«‹å„ªåŒ–ä¸Šä¸‹æ–‡"]

    subgraph ContextBuilding["ä¸Šä¸‹æ–‡å»ºç«‹"]
        ExtractVars["æå–è®Šæ•¸<br/>\$\{variable\}"]
        BuildCurrent["çµ„åˆç•¶å‰æç¤ºè©<br/>prefix + suffix"]
        ReplaceVars["æ›¿æ›ç¯„æœ¬è®Šæ•¸<br/>tool.*, philosophy, framework"]
    end

    BuildContext --> ContextBuilding
    ContextBuilding --> FinalPrompt["ğŸ¯ æœ€çµ‚è¶…ç´šæç¤ºè©"]

    FinalPrompt --> LogPrompt["ğŸ“ å¾Œç«¯æ—¥èªŒè¼¸å‡º<br/>å®Œæ•´æç¤ºè©"]
    LogPrompt --> CallGemini["ğŸ¤– å‘¼å« Gemini API<br/>generateOptimizedPrompt"]

    CallGemini --> KeyPoolFlow["åŸ·è¡Œé‡‘é‘°æ± æµç¨‹<br/>(åƒè€ƒé‡‘é‘°æ± æ¶æ§‹åœ–)"]

    KeyPoolFlow --> GeminiResult{"Gemini çµæœ?"}
    GeminiResult -->|æˆåŠŸ| ExtractText["ğŸ“„ æå–ç´”æ–‡å­—å›æ‡‰"]
    GeminiResult -->|å¤±æ•—| GeminiError["Gemini éŒ¯èª¤è™•ç†"]

    ExtractText --> CleanText["ğŸ§¹ æ¸…ç† Markdown æ¨™è¨˜<br/>ç§»é™¤ ```"]
    CleanText --> Return200["âœ… è¿”å› 200 + å„ªåŒ–çµæœ"]

    GeminiError --> Error500["è¿”å› 500 éŒ¯èª¤"]

    Error400 --> End
    Error404 --> End
    Error500 --> End
    Return200 --> End["ğŸ“¤ çµæŸ"]

    classDef startClass fill:#e8f5e9,stroke:#2e7d32,stroke-width:3px
    classDef processClass fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef decisionClass fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef errorClass fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef successClass fill:#f1f8e9,stroke:#558b2f,stroke-width:2px

    class Start,End startClass
    class LoadTemplate,QueryDB,BuildContext,CallGemini,KeyPoolFlow processClass
    class ValidateReq,TemplateType,ToolExists,GeminiResult decisionClass
    class Error400,Error404,Error500,GeminiError errorClass
    class Return200,ExtractText,CleanText successClass
```
