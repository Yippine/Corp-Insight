# è³‡æ–™åº«é€£ç·šç®¡ç†

```mermaid
flowchart TD
    subgraph Application["ğŸš€ æ‡‰ç”¨ç¨‹å¼"]
        APIRoute["API Route"]
        ServerComponent["Server Component"]
        Script["CLI Script"]
    end

    APIRoute --> ConnectDB["connectToDatabase()"]
    ServerComponent --> ConnectDB
    Script --> ConnectDB

    ConnectDB --> CheckCache{"é€£ç·šå·²å¿«å–?<br/>connection.isConnected"}

    CheckCache -->|æ˜¯| ReuseConn["â™»ï¸ é‡ç”¨ç¾æœ‰é€£ç·š"]
    CheckCache -->|å¦| GetURI["å–å¾— MongoDB URI<br/>process.env.MONGODB_URI"]

    GetURI --> URICheck{"URI å­˜åœ¨?"}
    URICheck -->|å¦| DefaultURI["ä½¿ç”¨é è¨­ URI<br/>mongodb://localhost:27017"]
    URICheck -->|æ˜¯| ConfigOpts["é…ç½®é€£ç·šé¸é …"]
    DefaultURI --> ConfigOpts

    subgraph ConnOptions["é€£ç·šé…ç½®"]
        MaxPool["maxPoolSize: 10"]
        Timeout["timeouts: 5s/45s/10s"]
        IPv4["family: 4"]
        Retry["retryWrites: true"]
    end

    ConfigOpts --> ConnOptions
    ConnOptions --> Connect["mongoose.connect()"]

    Connect --> ConnResult{"é€£ç·šçµæœ?"}

    ConnResult -->|æˆåŠŸ| CacheConn["å¿«å–é€£ç·šç‹€æ…‹<br/>connection.isConnected = 1"]
    ConnResult -->|å¤±æ•—| ErrorHandle["éŒ¯èª¤è™•ç†"]

    ErrorHandle --> ErrorType{"éŒ¯èª¤é¡å‹?"}
    ErrorType -->|ECONNREFUSED| RefusedMsg["æç¤º: æª¢æŸ¥ MongoDB æœå‹™"]
    ErrorType -->|Authentication failed| AuthMsg["æç¤º: æª¢æŸ¥å¸³å¯†æ¬Šé™"]
    ErrorType -->|å…¶ä»–| ThrowError["æ‹‹å‡ºéŒ¯èª¤"]

    CacheConn --> LogSuccess["è¨˜éŒ„æˆåŠŸæ—¥èªŒ<br/>database name, status"]
    ReuseConn --> Return["è¿”å› mongoose å¯¦ä¾‹"]
    LogSuccess --> Return

    subgraph Listeners["äº‹ä»¶ç›£è½å™¨"]
        OnConnected["connected â†’ è¨˜éŒ„é€£ç·š"]
        OnError["error â†’ è¨˜éŒ„éŒ¯èª¤"]
        OnDisconnected["disconnected â†’ è¨˜éŒ„æ–·ç·š"]
        OnReconnected["reconnected â†’ è¨˜éŒ„é‡é€£"]
    end

    subgraph Signals["é€²ç¨‹ä¿¡è™Ÿ"]
        SIGINT["SIGINT â†’ é—œé–‰é€£ç·š"]
        SIGTERM["SIGTERM â†’ é—œé–‰é€£ç·š"]
    end

    Connect -.ç›£è½.-> Listeners
    Return -.ç›£è½.-> Signals

    classDef appClass fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef processClass fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef successClass fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef errorClass fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef configClass fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px

    class Application appClass
    class ConnectDB,CheckCache,GetURI,ConfigOpts,Connect processClass
    class ReuseConn,CacheConn,LogSuccess,Return successClass
    class ErrorHandle,ErrorType,RefusedMsg,AuthMsg,ThrowError errorClass
    class ConnOptions,Listeners,Signals configClass
```
