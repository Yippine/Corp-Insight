# ä¸­ä»‹å±¤è·¯ç”±æ±ºç­–æ¨¹

```mermaid
flowchart TD
    Start["ğŸ“¥ æ”¶åˆ° HTTP è«‹æ±‚"] --> OptionsCheck{"æ–¹æ³• = OPTIONS?"}

    OptionsCheck -->|æ˜¯| OptionsResponse["è¿”å› 200 + CORS é ­"]
    OptionsCheck -->|å¦| GetHost["å–å¾— host èˆ‡ pathname"]

    GetHost --> EnvCheck{"ç’°å¢ƒé¡å‹?"}

    EnvCheck -->|dev-local| DevFlow["ğŸ  é–‹ç™¼ç’°å¢ƒæµç¨‹"]
    EnvCheck -->|prod-local| ProdLocalFlow["ğŸ”§ æœ¬åœ°ç”Ÿç”¢æµç¨‹"]
    EnvCheck -->|prod-production| ProdFlow["ğŸŒ æ­£å¼ç’°å¢ƒæµç¨‹"]

    DevFlow --> DevProcess["ä¿æŒæ‰€æœ‰è·¯ç”±ä¸è®Š<br/>/aitool/* æ­£å¸¸ä½¿ç”¨"]
    DevProcess --> SetCORS["è¨­å®š CORS é ­"]
    SetCORS --> NextResponse["NextResponse.next()"]

    ProdLocalFlow --> BlockCheck{"è·¯å¾‘ = /aitool/*?"}
    BlockCheck -->|æ˜¯| Block404["è¿”å› 404"]
    BlockCheck -->|å¦| ProdLocalProcess["å…¶ä»–è«‹æ±‚æ­£å¸¸è™•ç†"]
    ProdLocalProcess --> SetCORS

    ProdFlow --> ProdBlockCheck{"è·¯å¾‘ = /aitool/*?"}
    ProdBlockCheck -->|æ˜¯| Block404
    ProdBlockCheck -->|å¦| DomainCheck{"ç•¶å‰åŸŸå?"}

    DomainCheck -->|aitools.leopilot.com| AIToolsDomainFlow["AI å·¥å…·åŸŸåæµç¨‹"]
    DomainCheck -->|corpinsight.leopilot.com| MainDomainFlow["ä¸»ç«™åŸŸåæµç¨‹"]

    AIToolsDomainFlow --> PathCheck{"è·¯å¾‘é¡å‹?"}
    PathCheck -->|AI å·¥å…·è·¯å¾‘<br/>/search, /detail, /api/aitool| AllowAITools["å…è¨±è¨ªå•"]
    PathCheck -->|é€šç”¨è·¯å¾‘<br/>/faq, /privacy, /feedback| AllowUniversal["å…è¨±è¨ªå•"]
    PathCheck -->|å…¶ä»–è·¯å¾‘| RedirectMain["é‡å®šå‘åˆ°ä¸»ç«™ (301)"]

    MainDomainFlow --> AllowMain["å…è¨±æ‰€æœ‰é /aitool/* è·¯å¾‘"]

    AllowAITools --> SetCORS
    AllowUniversal --> SetCORS
    AllowMain --> SetCORS
    RedirectMain --> End
    Block404 --> End
    OptionsResponse --> End
    NextResponse --> End["ğŸ“¤ è¿”å›éŸ¿æ‡‰"]

    classDef startClass fill:#e8f5e9,stroke:#2e7d32,stroke-width:3px
    classDef decisionClass fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef processClass fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef errorClass fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef successClass fill:#f1f8e9,stroke:#558b2f,stroke-width:2px

    class Start,End startClass
    class OptionsCheck,EnvCheck,BlockCheck,ProdBlockCheck,DomainCheck,PathCheck decisionClass
    class DevFlow,ProdLocalFlow,ProdFlow,AIToolsDomainFlow,MainDomainFlow processClass
    class Block404,RedirectMain errorClass
    class AllowAITools,AllowUniversal,AllowMain,NextResponse successClass
```
