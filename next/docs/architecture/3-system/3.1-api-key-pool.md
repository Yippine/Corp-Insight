# Gemini AI æ™ºæ…§é‡‘é‘°æ± æ¶æ§‹

```mermaid
flowchart TD
    subgraph Request["ğŸ“¥ API è«‹æ±‚"]
        StreamReq["ä¸²æµç”Ÿæˆè«‹æ±‚<br/>streamGenerateContent"]
        OptimizeReq["æç¤ºè©å„ªåŒ–è«‹æ±‚<br/>generateOptimizedPrompt"]
    end

    subgraph KeyPoolSystem["ğŸ”‘ é‡‘é‘°æ± ç³»çµ±"]
        direction TB
        EnvDetect["ç’°å¢ƒæª¢æ¸¬<br/>getApiKeyPool"]

        subgraph Pools["é‡‘é‘°æ± "]
            DevPool["é–‹ç™¼æ± <br/>DEV_PRIMARY + DEV_BACKUP"]
            ProdPool["ç”Ÿç”¢æ± <br/>PROD_PRIMARY + PROD_BACKUP"]
            BatchPool["æ‰¹æ¬¡æ± <br/>BATCH_PRIMARY + BATCH_BACKUP"]
        end

        StrategySelect["ç­–ç•¥é¸æ“‡<br/>getApiKeyStrategy"]

        subgraph Strategies["åŸ·è¡Œç­–ç•¥"]
            Failover["ğŸ”„ Failover<br/>ä¸»å‚™åˆ‡æ›"]
            RoundRobin["ğŸ” Round-Robin<br/>è¼ªè©¢è² è¼‰å‡è¡¡"]
        end
    end

    subgraph CircuitBreakerSystem["ğŸ›¡ï¸ æ–·è·¯å™¨ç³»çµ±"]
        direction TB
        PreCheck["ğŸ” å‘¼å«å‰æª¢æŸ¥<br/>checkKeyState"]

        subgraph StateCheck["ç‹€æ…‹æª¢æŸ¥"]
            HealthyCheck["âœ… HEALTHY<br/>å…è¨±ä½¿ç”¨"]
            UnhealthyCheck["âš ï¸ UNHEALTHY<br/>æª¢æŸ¥ retryAt"]
            CooldownCheck["â„ï¸ Cooldown<br/>è·³éæ­¤é‡‘é‘°"]
        end

        APICall["ğŸŒ åŸ·è¡Œ API å‘¼å«<br/>attemptApiCall"]

        subgraph Result["çµæœè™•ç†"]
            Success["âœ… æˆåŠŸ"]
            Failure["âŒ å¤±æ•—"]
        end

        UpdateState["ğŸ“ æ›´æ–°ç‹€æ…‹<br/>updateKeyState"]

        subgraph BackoffLogic["é€€é¿é‚è¼¯"]
            DailyCheck["æ¯æ—¥å¤±æ•—æª¢æŸ¥<br/>dailyFailureCount > threshold"]
            RPDCooldown["ğŸŒ… RPD å†·å‡<br/>åˆ° PT åˆå¤œ"]
            ExpoBackoff["ğŸ“ˆ æŒ‡æ•¸é€€é¿<br/>2^(n-2) * 2min + jitter"]
            MaxBackoff["â° æœ€å¤§ 120 åˆ†é˜"]
        end
    end

    subgraph Database["ğŸ’¾ è³‡æ–™åº«"]
        ApiKeyStatus["ApiKeyStatus Collection<br/>- keyIdentifier<br/>- status (HEALTHY/UNHEALTHY)<br/>- failureCount<br/>- dailyFailureCount<br/>- retryAt<br/>- recentErrors"]
    end

    %% æµç¨‹é€£æ¥
    StreamReq --> EnvDetect
    OptimizeReq --> EnvDetect

    EnvDetect --> Pools
    DevPool --> StrategySelect
    ProdPool --> StrategySelect
    BatchPool --> StrategySelect

    StrategySelect --> Strategies
    Failover --> PreCheck
    RoundRobin --> PreCheck

    PreCheck --> StateCheck
    HealthyCheck --> APICall
    UnhealthyCheck --> CooldownCheck
    CooldownCheck -->|æœªåˆ°æ™‚é–“| Failover
    CooldownCheck -->|å·²åˆ°æ™‚é–“| APICall

    APICall --> Result
    Success --> UpdateState
    Failure --> UpdateState

    UpdateState -->|å¤±æ•—| BackoffLogic
    DailyCheck -->|è¶…é| RPDCooldown
    DailyCheck -->|æœªè¶…é| ExpoBackoff
    ExpoBackoff --> MaxBackoff

    UpdateState --> Database
    PreCheck --> Database

    classDef reqClass fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef poolClass fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef cbClass fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef dbClass fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px

    class Request reqClass
    class KeyPoolSystem,Pools,Strategies poolClass
    class CircuitBreakerSystem,StateCheck,BackoffLogic cbClass
    class Database dbClass
```
