# å®Œæ•´ç³»çµ±æ¶æ§‹åœ–

```mermaid
flowchart TD
    %% ============================================
    %% ä½¿ç”¨è€…å…¥å£å±¤ (User Entry Layer)
    %% ============================================
    subgraph UserLayer["ğŸŒ ä½¿ç”¨è€…å…¥å£å±¤"]
        direction TB
        User["ğŸ‘¤ ä½¿ç”¨è€…"]
        MainDomain["ğŸ¢ ä¸»ç«™<br/>corpinsight.leopilot.com"]
        AIToolsDomain["ğŸ¤– AI å·¥å…·ç«™<br/>aitools.leopilot.com"]
        LocalDev["ğŸ’» æœ¬åœ°é–‹ç™¼<br/>localhost:3000"]
    end

    %% ============================================
    %% ä¸­ä»‹å±¤ (Middleware Layer)
    %% ============================================
    subgraph MiddlewareLayer["ğŸ›¡ï¸ ä¸­ä»‹å±¤"]
        direction TB
        Middleware["âš™ï¸ Next.js Middleware<br/>middleware.ts"]

        subgraph MiddlewareLogic["ä¸­ä»‹é‚è¼¯"]
            EnvDetect["ğŸ” ç’°å¢ƒæª¢æ¸¬<br/>dev/prod-local/prod-production"]
            CORS["ğŸ”’ CORS è™•ç†<br/>setCorsHeaders"]
            DomainRoute["ğŸ”€ åŸŸåè·¯ç”±<br/>isAiToolsDomain"]
            PathBlock["ğŸš« è·¯å¾‘å°é–<br/>/aitool/* (prod)"]
            Redirect["â†ªï¸ é‡å®šå‘<br/>è·¨åŸŸ 301"]
        end
    end

    %% ============================================
    %% æ‡‰ç”¨å±¤ - è·¯ç”± (Application Layer - Routes)
    %% ============================================
    subgraph AppRoutes["ğŸ“„ æ‡‰ç”¨å±¤ - é é¢è·¯ç”± (App Router)"]
        direction TB

        subgraph CompanyRoutes["ğŸ¢ ä¼æ¥­æ¨¡çµ„"]
            CompanySearch["ğŸ” ä¼æ¥­æœå°‹<br/>/company/search"]
            CompanyDetail["ğŸ“‹ ä¼æ¥­è©³æƒ…<br/>/company/detail/[taxId]"]
        end

        subgraph TenderRoutes["ğŸ“ æ¨™æ¡ˆæ¨¡çµ„"]
            TenderSearch["ğŸ” æ¨™æ¡ˆæœå°‹<br/>/tender/search"]
            TenderDetail["ğŸ“‹ æ¨™æ¡ˆè©³æƒ…<br/>/tender/detail/[tenderId]"]
        end

        subgraph AIToolRoutes["ğŸ¤– AI å·¥å…·æ¨¡çµ„"]
            AIToolSearch["ğŸ” å·¥å…·æœå°‹<br/>/aitool/search or /search"]
            AIToolDetail["ğŸ“‹ å·¥å…·è©³æƒ…<br/>/aitool/detail or /detail"]
        end

        subgraph UniversalRoutes["ğŸŒ é€šç”¨é é¢"]
            FAQ["â“ FAQ"]
            Feedback["ğŸ’¬ æ„è¦‹å›é¥‹"]
            Privacy["ğŸ” éš±ç§æ”¿ç­–"]
            Admin["ğŸ‘‘ ç®¡ç†å¾Œå°<br/>/admin"]
        end
    end

    %% ============================================
    %% æ‡‰ç”¨å±¤ - API (Application Layer - API)
    %% ============================================
    subgraph APILayer["ğŸ”Œ API å±¤ (Server-side Routes)"]
        direction TB

        subgraph CompanyAPI["ğŸ¢ ä¼æ¥­ API"]
            CompanyTwincn["ğŸ“Š å°ç£å…¬å¸è³‡æ–™<br/>/api/company/twincn"]
        end

        subgraph TenderAPI["ğŸ“ æ¨™æ¡ˆ API"]
            TenderProxy["ğŸ”„ æ¨™æ¡ˆæœå°‹ä»£ç†<br/>/api/tender-search-proxy"]
            TenderDetailProxy["ğŸ”„ æ¨™æ¡ˆè©³æƒ…ä»£ç†<br/>/api/tender-detail-proxy"]
        end

        subgraph AIToolAPI["ğŸ¤– AI å·¥å…· API"]
            AIToolQuery["ğŸ“‹ å·¥å…·æŸ¥è©¢<br/>/api/aitool"]
            UpdatePrompt["âœï¸ æ›´æ–°æç¤ºè©<br/>/api/aitool/update-prompt"]
            GeminiStream["ğŸŒŠ Gemini ä¸²æµ<br/>/api/gemini/stream"]
            PromptOptimize["ğŸ¯ æç¤ºè©å„ªåŒ–<br/>/api/prompt/optimize"]
        end

        subgraph SystemAPI["âš™ï¸ ç³»çµ± API"]
            HealthCheck["ğŸ’š å¥åº·æª¢æŸ¥<br/>/api/health"]
            Auth["ğŸ”‘ èªè­‰<br/>/api/auth/[...nextauth]"]
            FeedbackAPI["ğŸ’¬ æ„è¦‹å›é¥‹<br/>/api/feedback/*"]
            AdminAPI["ğŸ‘‘ ç®¡ç† API<br/>/api/admin/*"]
            SitemapCmd["ğŸ—ºï¸ Sitemap æŒ‡ä»¤<br/>/api/sitemap-command"]
        end
    end

    %% ============================================
    %% æœå‹™å±¤ (Service Layer)
    %% ============================================
    subgraph ServiceLayer["âš¡ æœå‹™å±¤ (Business Logic)"]
        direction TB

        subgraph GeminiService["ğŸ§  Gemini AI æœå‹™"]
            direction LR
            GeminiServer["gemini.server.ts"]
            KeyPool["ğŸ”‘ é‡‘é‘°æ± ç®¡ç†<br/>getApiKeyPool"]
            Strategy["ğŸ“Š ç­–ç•¥é¸æ“‡<br/>Failover/Round-Robin"]
            CircuitBreaker["ğŸ›¡ï¸ æ–·è·¯å™¨<br/>checkKeyState"]
            Backoff["â±ï¸ æŒ‡æ•¸é€€é¿<br/>updateKeyState"]
        end

        subgraph DataServices["ğŸ“¦ è³‡æ–™æœå‹™"]
            CompanyService["ğŸ¢ ä¼æ¥­æœå‹™<br/>lib/company/api.ts"]
            TenderService["ğŸ“ æ¨™æ¡ˆæœå‹™<br/>lib/tender/api.ts"]
            AIToolService["ğŸ¤– AI å·¥å…·æœå‹™<br/>lib/aitool/data.ts"]
            FeedbackService["ğŸ’¬ æ„è¦‹å›é¥‹<br/>lib/feedback/"]
        end

        subgraph UtilServices["ğŸ› ï¸ å·¥å…·æœå‹™"]
            TCMFormatter["ğŸ‡¹ğŸ‡¼ ç¹ç°¡è½‰æ›<br/>utils/tcmFormatter.ts"]
            Formatters["ğŸ“ æ ¼å¼åŒ–å·¥å…·<br/>lib/utils/formatters.ts"]
        end
    end

    %% ============================================
    %% è³‡æ–™å±¤ (Data Layer)
    %% ============================================
    subgraph DataLayer["ğŸ’¾ è³‡æ–™å±¤"]
        direction TB

        subgraph Database["ğŸ—„ï¸ MongoDB"]
            direction LR
            DBConnection["é€£ç·šç®¡ç†<br/>database/connection.ts"]

            subgraph Models["ğŸ“Š è³‡æ–™æ¨¡å‹"]
                CompanyModel["ğŸ¢ Company"]
                AIToolModel["ğŸ¤– AITool"]
                FeedbackModel["ğŸ’¬ Feedback"]
                ApiKeyModel["ğŸ”‘ ApiKeyStatus"]
                PromptTemplate["ğŸ“ PromptTemplate"]
            end
        end

        subgraph ExternalAPIs["ğŸŒ å¤–éƒ¨ API"]
            G0VCompany["ğŸ¢ g0v ä¼æ¥­è³‡æ–™<br/>company.g0v.ronny.tw"]
            TenderExternal["ğŸ“ æ¨™æ¡ˆå¤–éƒ¨ API"]
        end

        subgraph Cache["âš¡ å¿«å–å±¤"]
            Redis["Redis<br/>Sitemap å¿«å–"]
        end
    end

    %% ============================================
    %% çµ„ä»¶å±¤ (Component Layer)
    %% ============================================
    subgraph ComponentLayer["ğŸ§© çµ„ä»¶å±¤ (UI Components)"]
        direction TB

        subgraph Layout["ğŸ“ ä½ˆå±€çµ„ä»¶"]
            RootLayout["æ ¹ä½ˆå±€<br/>layout.tsx"]
            Header["ğŸ¯ é é¦–<br/>Header.tsx"]
            Footer["ğŸ¦¶ é å°¾<br/>Footer.tsx"]
        end

        subgraph FeatureComponents["ğŸ¨ åŠŸèƒ½çµ„ä»¶"]
            CompanyComps["ğŸ¢ ä¼æ¥­çµ„ä»¶<br/>components/company/"]
            TenderComps["ğŸ“ æ¨™æ¡ˆçµ„ä»¶<br/>components/tender/"]
            AIToolComps["ğŸ¤– AI å·¥å…·çµ„ä»¶<br/>components/aitool/"]
            ChatbotWrapper["ğŸ’¬ èŠå¤©æ©Ÿå™¨äºº<br/>ChatbotWrapper.tsx"]
        end

        subgraph CommonComponents["ğŸ”§ é€šç”¨çµ„ä»¶"]
            UILib["ğŸ¨ UI åº«<br/>components/ui/"]
            Loading["â³ è¼‰å…¥çµ„ä»¶<br/>LoadingProvider"]
            SEO["ğŸ“Š SEO çµ„ä»¶<br/>components/SEO/"]
            Pagination["ğŸ“„ åˆ†é <br/>Pagination.tsx"]
        end
    end

    %% ============================================
    %% Hooks å±¤ (Custom Hooks)
    %% ============================================
    subgraph HooksLayer["ğŸª React Hooks å±¤"]
        direction LR
        useGemini["ğŸ§  useGeminiStream"]
        usePrompt["ğŸ“ usePromptEngine"]
        useTender["ğŸ“ useTenderSearch"]
        useCompany["ğŸ¢ useCompanyData"]
        useSitemap["ğŸ—ºï¸ useSitemapStatus"]
    end

    %% ============================================
    %% ç›£æ§å±¤ (Monitoring Layer)
    %% ============================================
    subgraph MonitoringLayer["ğŸ“Š ç›£æ§å±¤"]
        direction LR
        GA["ğŸ“ˆ Google Analytics"]
        WebVitals["âš¡ Web Vitals Tracker"]
        HealthAPI["ğŸ’š Health Check API"]
    end

    %% ============================================
    %% é€£æ¥é—œä¿‚ (Connections)
    %% ============================================

    %% ä½¿ç”¨è€… -> å…¥å£
    User -->|è¨ªå•ä¸»ç«™| MainDomain
    User -->|è¨ªå• AI ç«™| AIToolsDomain
    User -->|æœ¬åœ°é–‹ç™¼| LocalDev

    %% å…¥å£ -> ä¸­ä»‹å±¤
    MainDomain --> Middleware
    AIToolsDomain --> Middleware
    LocalDev --> Middleware

    %% ä¸­ä»‹å±¤é‚è¼¯æµ
    Middleware --> EnvDetect
    EnvDetect --> DomainRoute
    DomainRoute --> PathBlock
    PathBlock --> CORS
    CORS --> Redirect

    %% ä¸­ä»‹å±¤ -> æ‡‰ç”¨å±¤è·¯ç”±
    Middleware --> CompanyRoutes
    Middleware --> TenderRoutes
    Middleware --> AIToolRoutes
    Middleware --> UniversalRoutes

    %% é é¢è·¯ç”± -> API å±¤
    CompanySearch --> CompanyAPI
    CompanyDetail --> CompanyAPI
    TenderSearch --> TenderAPI
    TenderDetail --> TenderAPI
    AIToolSearch --> AIToolAPI
    AIToolDetail --> AIToolAPI
    Feedback --> FeedbackAPI
    Admin --> AdminAPI

    %% API å±¤ -> æœå‹™å±¤
    CompanyTwincn --> CompanyService
    TenderProxy --> TenderService
    TenderDetailProxy --> TenderService
    AIToolQuery --> AIToolService
    UpdatePrompt --> AIToolService
    GeminiStream --> GeminiServer
    PromptOptimize --> GeminiServer

    %% æœå‹™å±¤å…§éƒ¨æµ
    GeminiServer --> KeyPool
    KeyPool --> Strategy
    Strategy --> CircuitBreaker
    CircuitBreaker --> Backoff

    %% æœå‹™å±¤ -> è³‡æ–™å±¤
    GeminiServer --> ApiKeyModel
    CompanyService --> G0VCompany
    CompanyService --> CompanyModel
    TenderService --> TenderExternal
    AIToolService --> AIToolModel
    FeedbackService --> FeedbackModel

    %% è³‡æ–™å±¤é€£æ¥
    DBConnection --> Models
    PromptOptimize --> PromptTemplate
    SitemapCmd --> Redis

    %% çµ„ä»¶å±¤ -> Hooks
    FeatureComponents --> HooksLayer

    %% Hooks -> API
    useGemini --> GeminiStream
    usePrompt --> PromptOptimize
    useTender --> TenderAPI

    %% ä½ˆå±€çµ„ä»¶
    RootLayout --> Header
    RootLayout --> Footer
    RootLayout --> Loading
    RootLayout --> ChatbotWrapper

    %% ç›£æ§é€£æ¥
    RootLayout --> GA
    RootLayout --> WebVitals
    HealthCheck --> HealthAPI

    %% æ¨£å¼å®šç¾©
    classDef userClass fill:#e1f5ff,stroke:#01579b,stroke-width:2px,color:#000
    classDef middlewareClass fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000
    classDef routeClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
    classDef apiClass fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px,color:#000
    classDef serviceClass fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:#000
    classDef dataClass fill:#fff9c4,stroke:#f57f17,stroke-width:2px,color:#000
    classDef componentClass fill:#e0f2f1,stroke:#004d40,stroke-width:2px,color:#000
    classDef monitorClass fill:#ffebee,stroke:#b71c1c,stroke-width:2px,color:#000

    class UserLayer userClass
    class MiddlewareLayer,Middleware,MiddlewareLogic middlewareClass
    class AppRoutes,CompanyRoutes,TenderRoutes,AIToolRoutes,UniversalRoutes routeClass
    class APILayer,CompanyAPI,TenderAPI,AIToolAPI,SystemAPI apiClass
    class ServiceLayer,GeminiService,DataServices,UtilServices serviceClass
    class DataLayer,Database,ExternalAPIs,Cache dataClass
    class ComponentLayer,Layout,FeatureComponents,CommonComponents,HooksLayer componentClass
    class MonitoringLayer monitorClass
```
